= Deploy high availability federated authentication for Microsoft 365 in Azure
:audience: ITPro
:author: kelleyvice-msft
:description: Summary: Configure high availability federated authentication for your Microsoft 365 subscription in Microsoft Azure.
:f1.keywords: ["CSH"]
:manager: scotv
:ms.assetid: 34b1ab9c-814c-434d-8fd0-e5a82cd9bff6
:ms.author: kvice
:ms.collection: ["Ent_O365", "Strat_O365_Enterprise"]
:ms.custom: ["Ent_Solutions"]
:ms.date: 11/25/2019
:ms.localizationpriority: medium
:ms.service: microsoft-365-enterprise
:ms.topic: article
:search.appverid: ["MET150s"]

== Deploy high availability federated authentication for Microsoft 365 in Azure

This article has links to the step-by-step instructions for deploying high availability federated authentication for Microsoft Microsoft 365 in Azure infrastructure services with these virtual machines:

* Two web application proxy servers
* Two Active Directory Federation Services (AD FS) servers
* Two replica domain controllers
* One directory synchronization server running Azure AD Connect

Here is the configuration, with placeholder names for each server.

*A high availability federated authentication for Microsoft 365 infrastructure in Azure*

image::../media/c5da470a-f2aa-489a-a050-df09b4d641df.png[The final configuration of the high availability Microsoft 365 federated authentication infrastructure in Azure.]

All of the virtual machines are in a single cross-premises Azure virtual network (VNet).

____
[!NOTE] Federated authentication of individual users does not rely on any on-premises resources.
However, if the cross-premises connection becomes unavailable, the domain controllers in the VNet will not receive updates to user accounts and groups made in the on-premises Active Directory Domain Services (AD DS).
To ensure this does not happen, you can configure high availability for your cross-premises connection.
For more information, see link:/azure/vpn-gateway/vpn-gateway-highlyavailable[Highly Available Cross-Premises and VNet-to-VNet Connectivity]
____

Each pair of virtual machines for a specific role is in its own subnet and availability set.

____
[!NOTE] Because this VNet is connected to the on-premises network, this configuration does not include jumpbox or monitoring virtual machines on a management subnet.
For more information, see link:/azure/guidance/guidance-compute-n-tier-vm[Running Windows VMs for an N-tier architecture].
____

The result of this configuration is that you will have federated authentication for all of your Microsoft 365 users, in which they can use their AD DS credentials to sign in rather than their Microsoft 365 account.
The federated authentication infrastructure uses a redundant set of servers that are more easily deployed in Azure infrastructure services, rather than in your on-premises edge network.

=== Bill of materials

This baseline configuration requires the following set of Azure services and components:

* Seven virtual machines
* One cross-premises virtual network with four subnets
* Four resource groups
* Three availability sets
* One Azure subscription

Here are the virtual machines and their default sizes for this configuration.

|===
| *Item* | *Virtual machine description* | *Azure gallery image* | *Default size*

| 1.
+
| First domain controller  +
| Windows Server 2016 Datacenter  +
| D2  +

| 2.
+
| Second domain controller  +
| Windows Server 2016 Datacenter  +
| D2  +

| 3.
+
| Azure AD Connect server  +
| Windows Server 2016 Datacenter  +
| D2  +

| 4.
+
| First AD FS server  +
| Windows Server 2016 Datacenter  +
| D2  +

| 5.
+
| Second AD FS server  +
| Windows Server 2016 Datacenter  +
| D2  +

| 6.
+
| First web application proxy server  +
| Windows Server 2016 Datacenter  +
| D2  +

| 7.
+
| Second web application proxy server  +
| Windows Server 2016 Datacenter  +
| D2  +
|===

To compute the estimated costs for this configuration, see the https://azure.microsoft.com/pricing/calculator/[Azure pricing calculator]

=== Phases of deployment

You deploy this workload in the following phases:

* xref:high-availability-federated-authentication-phase-1-configure-azure.adoc[Phase 1: Configure Azure].
Create resource groups, storage accounts, availability sets, and a cross-premises virtual network.
* xref:high-availability-federated-authentication-phase-2-configure-domain-controllers.adoc[Phase 2: Configure domain controllers].
Create and configure replica AD DS domain controllers and the directory synchronization server.
* xref:high-availability-federated-authentication-phase-3-configure-ad-fs-servers.adoc[Phase 3: Configure AD FS servers].
Create and configure the two AD FS servers.
* xref:high-availability-federated-authentication-phase-4-configure-web-application-pro.adoc[Phase 4: Configure web application proxies].
Create and configure the two web application proxy servers.
* xref:high-availability-federated-authentication-phase-5-configure-federated-authentic.adoc[Phase 5: Configure federated authentication for Microsoft 365].
Configure federated authentication for your Microsoft 365 subscription.

These articles provide a prescriptive, phase-by-phase guide for a predefined architecture to create a functional, high availability federated authentication for Microsoft 365 in Azure infrastructure services.
Keep the following in mind:

* If you are an experienced AD FS implementer, feel free to adapt the instructions in phases 3 and 4 and build the set of servers that best suits your needs.
* If you already have an existing Azure hybrid cloud deployment with an existing cross-premises virtual network, feel free to adapt or skip the instructions in phases 1 and 2 and place the AD FS and web application proxy servers on the appropriate subnets.

To build a dev/test environment or a proof-of-concept of this configuration, see xref:federated-identity-for-your-microsoft-365-dev-test-environment.adoc[Federated identity for your Microsoft 365 dev/test environment].

=== Next step

Start the configuration of this workload with xref:high-availability-federated-authentication-phase-1-configure-azure.adoc[Phase 1: Configure Azure].
