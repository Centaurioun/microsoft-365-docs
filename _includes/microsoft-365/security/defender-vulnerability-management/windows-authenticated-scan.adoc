= 
siosulli
:keywords: Microsoft Defender Vulnerability Management, authenticated
scans

== Windows authenticated scan

{empty}[!INCLUDE link:../../includes/microsoft-defender.md[Microsoft 365
Defender rebranding]]

*Applies to:*

* https://go.microsoft.com/fwlink/?linkid=2154037[Microsoft Defender for
Endpoint Plan 2]
* link:index.yml[Microsoft Defender Vulnerability Management]
* https://go.microsoft.com/fwlink/?linkid=2118804[Microsoft 365
Defender]

{empty}[!includelink:../../includes/prerelease.md[Prerelease
information]]

____
[!Note] Want to experience Microsoft Defender Vulnerability Management?
Learn more about how you can sign up to the
link:../defender-vulnerability-management/get-defender-vulnerability-management.md[Microsoft
Defender Vulnerability Management public preview trial].
____

Windows authenticated scan provides the ability to run scans on
unmanaged Windows devices. You can remotely target by IP ranges or
hostnames and scan Windows services by providing Microsoft Defender
Vulnerability Management with credentials to remotely access the
devices. Once configured the targeted unmanaged devices will be scanned
regularly for software vulnerabilities.

This is applicable for devices that don’t have the Defender
Vulnerability Management or Defender for Endpoint agent deployed.

=== Scanner Installation

Similar to link:../defender-endpoint/network-devices.md[network device]
authenticated scan, you’ll need a scanning device with the scanner
installed. If you don’t already have the scanner installed, see
link:../defender-endpoint/network-devices.md#install-the-scanner[Install
the scanner] for steps on how to download and install it.

____
[!NOTE] No changes are required for pre-existing installed scanners.
____

=== Pre-requisites

The following section lists the pre-requisites you need to configure to
use Windows authenticated scan.

==== Scanning account

A scanning account is required to remotely access the devices. This must
be a
link:/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview/[Group
Managed Service Account (gMsa)]. To create a gMsa account:

[arabic]
. On your domain controller in a PowerShell window, run:

[source,powershell]
----
New-ADServiceAccount -name gmsa1 -PrincipalsAllowedToRetrieveManagedPassword scanner-win11-i$ -KerberosEncryptionType RC4, AES128, AES256 –verbose
----

* gmsa1 stands for the name of the account you are creating, and
scanner-win11-I$ stands for the machine name where the scanner agent
will run. Only this machine will be able to retrieve the account
password. You can provide a comma separated list of machines.
* Modifying an existing account can be done with _Get-ADServiceAccount_
and _Set-ADServiceAccount_

[arabic, start=2]
. To Install the AD Service Account, on the machine where the scanner
agent will run using an elevated PowerShell window, run:

[source,powershell]
----
Install-ADServiceAccount -Identity gmsa1
----

If your PowerShell doesn’t recognize those commands, it probably means
you’re missing a required PowerShell module. Instructions on how to
install the module vary depending on your operating system. For more
information, see
link:/windows-server/security/group-managed-service-accounts/getting-started-with-group-managed-service-accounts/[Getting
Started with Group Managed Service Accounts].

==== Devices to be scanned

Use the table below for guidance on what needs to be configured on the
devices that will be scanned.

____
[!Note] The account to be used for scanning requires all the permissions
below. The below steps are only one recommended way to configure the
permissions on the devices to be scanned and uses the Performance
Monitor Users group. You can also add the account to a different user
group and give all the permissions required to that group, or you can
give these permissions explicitly to the scanning account.
____

[width="100%",cols="<50%,<50%",options="header",]
|===
|Devices to be scanned requirements |Description
|Windows Management Instrumentation (WMI) and Registry is enabled |To
enable remote Windows Management Instrumentation (WMI): - Verify the
Windows Management Instrumentation service is running. - Go to *Control
Panel* > *All Control Panel Items* > *Windows Defender Firewall* >
*Allowed applications* and ensure Windows Management Instrumentation
(WMI) is allowed through Windows Firewall.

|Scanning account is a member of Performance Monitor Users group |The
scanning account must be a member of the *Performance Monitor Users*
group on the device to be scanned.

|Performance Monitor Users group has `Enable Account' and `Remote
Enable' permissions on Root/CIMV2 WMI namespace |To verify or enable
these permissions: - Run wmimgmt.msc - Right click *WMI Control (Local)*
and select *Properties* - Go to the Security tab - Select the relevant
WMI namespace and select *Security* - Add the specified group and select
to allow the specific permissions - Select *Advanced*, choose the
specified entry, and select *Edit* - Set *Applies To* to ``This
namespace and subnamespaces''

|*Performance Monitor Users* group should have permissions on DCOM
operations |To verify or enable these permissions: - Run dcomcnfg -
Navigate to *Component Services* > *Computers* > *My Computer* - Right
click My Computer and choose *Properties* - Go to the COM Security tab -
Go to *Launch and Activation Permissions* and select *Edit Limits* - Add
the specified group and select to allow *Remote Launch* and *Remote
Activation*
|===

=== Configure a new authenticated scan

To configure a new authenticated scan:

[arabic]
. Go to *Settings* > *Device discovery* > *Authenticated scans* in the
https://security.microsoft.com[Microsoft 365 Defender portal].
. Select *Add new scan* and choose *Windows authenticated scan* and
select *Next*.
+
:::image type=``content''
source=``../../media/defender-vulnerability-management/authenticated-scan.png''
alt-text=``Screenshot of the add new authenticated scan screen''
lightbox=``../../media/defender-vulnerability-management/authenticated-scan.png'':::
. Enter a *Scan name*.
. Select the *Scanning device:* The onboarded device you’ll use to scan
the unmanaged devices.
. Enter the *Target (range):* The IP address ranges or hostnames you
want to scan. You can either enter the addresses or import a CSV file.
Importing a file will override any manually added addresses.
. Select the *Scan interval:* By default, the scan will run every four
hours, you can change the scan interval or have it only run once, by
selecting `Do not repeat'.
. Choose your *Authentication method* - there are two options to choose
from:
* Kerberos (preferred)
* Negotiate
+
____
[!Note] Negotiate option will fallback to NTLM in cases where Kerberos
fails. Using NTLM is not recommended as it is not a secure protocol.
____
. Enter the credentials Microsoft Defender Vulnerability Management will
use to remotely access the devices:
* *Use azure KeyVault:* If you manage your credentials in Azure KeyVault
you can enter the Azure KeyVault URL and Azure KeyVault secret name to
be accessed by the scanning device to provide credentials
* *Enter
link:/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview/[gMSA
account details]:* Input the Domain and Username
. Select *Next* to run or skip the test scan. For more information on
test scans, see
link:../defender-endpoint/network-devices.md#scan-and-add-network-devices[Scan
and add network devices].
. Select *Next* to review the settings and then select *Submit* to
create your new authenticated scan.

____
[!Note] As the authenticated scanner currently uses an encryption
algorithm that is not compliant with
link:/windows/security/threat-protection/security-policy-settings/system-cryptography-use-fips-compliant-algorithms-for-encryption-hashing-and-signing/[Federal
Information Processing Standards (FIPS)], the scanner can’t operate when
an organization enforces the use of FIPS compliant algorithms.

To allow algorithms that are not compliant with FIPS, set the following
value in the registry for the devices where the scanner will run:
Computer_LOCAL_MACHINEwith a DWORD value named *Enabled* and value of
*0x0*

FIPS compliant algorithms are only used in relation to departments and
agencies of the United States federal government.
____

==== Windows authenticated scan APIs

You can use APIs to create a new scan and view all existing configured
scans in your organization. For more information, see:

* link:../defender-endpoint/get-all-scan-definitions.md[Get all scan
definitions]
* link:../defender-endpoint/add-a-new-scan-definition.md[Add&#44; delete or
update a scan definition]
* link:../defender-endpoint/get-all-scan-agents.md[Get all scan agents]
* link:../defender-endpoint/get-scan-history-by-definition.md[Get scan
history by definition]
* link:../defender-endpoint/get-scan-history-by-session.md[Get scan
history by session]

=== Related articles

* link:../defender-endpoint/network-devices.md[Network devices]
