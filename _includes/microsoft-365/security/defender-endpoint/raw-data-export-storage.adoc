= 
mjcaparas
:keywords: raw data export, streaming API, API, Event Hubs, Azure
storage, storage account, Advanced Hunting, raw data sharing

== Configure Microsoft Defender for Endpoint to stream Advanced Hunting events to your Storage account

{empty}[!INCLUDE link:../../includes/microsoft-defender.md[Microsoft 365
Defender rebranding]]

*Applies to:*

* https://go.microsoft.com/fwlink/p/?linkid=2154037[Microsoft Defender
for Endpoint Plan 2]

____
[!NOTE] For the full data streaming experience available, please visit
link:/microsoft-365/security/defender/streaming-api[Stream Microsoft 365
Defender events | Microsoft Learn].
____

____
Want to experience Defender for Endpoint?
https://signup.microsoft.com/create-account/signup?products=7f379fee-c4f9-4278-b0a1-e4c8c2fcdf7e&ru=https://aka.ms/MDEp2OpenTrial?ocid=docs-wdatp-configuresiem-abovefoldlink[Sign
up for a free trial.]
____

=== Before you begin

[arabic]
. Create a link:/azure/storage/common/storage-account-overview[Storage
account] in your tenant.
. Log in to your https://ms.portal.azure.com/[Azure tenant], go to
*Subscriptions > Your subscription > Resource Providers > Register to
Microsoft.insights*.

=== Enable raw data streaming

[arabic]
. Log in to https://security.microsoft.com[Microsoft 365 Defender] as a
*_Global Administrator_* or *_Security Administrator_*.
. Go to
https://security.microsoft.com/settings/mtp_settings/raw_data_export[Data
export settings page] in Microsoft 365 Defender.
. Click on *Add data export settings*.
. Choose a name for your new settings.
. Choose *Forward events to Azure Storage*.
. Type your *Storage Account Resource ID*. In order to get your *Storage
Account Resource ID*, go to your Storage account page on
https://ms.portal.azure.com/[Azure portal] > properties tab > copy the
text under *Storage account resource ID*:
+
:::image type=``content''
source=``images/storage-account-resource-id.png'' alt-text=``The Event
Hubs with resource ID1''
lightbox=``images/storage-account-resource-id.png'':::
. Choose the events you want to stream and click *Save*.

=== The schema of the events in the Storage account

* A blob container will be created for each event type:
+
:::image type=``content''
source=``images/storage-account-event-schema.png'' alt-text=``The Event
Hubs with resource ID2''
lightbox=``images/storage-account-event-schema.png'':::
* The schema of each row in a blob is the following JSON:
+
[source,json]
----
{
  "time": "<The time WDATP received the event>"
  "tenantId": "<Your tenant ID>"
  "category": "<The Advanced Hunting table name with 'AdvancedHunting-' prefix>"
  "properties": { <WDATP Advanced Hunting event as Json> }
}
----
* Each blob contains multiple rows.
* Each row contains the event name, the time Defender for Endpoint
received the event, the tenant it belongs (you will only get events from
your tenant), and the event in JSON format in a property called
``properties''.
* For more information about the schema of Microsoft Defender for
Endpoint events, see link:advanced-hunting-overview.md[Advanced Hunting
overview].
* In Advanced Hunting, the *DeviceInfo* table has a column named
*MachineGroup* which contains the group of the device. Here every event
will be decorated with this column as well. See
link:machine-groups.md[Device Groups] for more information. > [!NOTE] >
Device group creation is supported in Defender for Endpoint Plan 1 and
Plan 2.

=== Data types mapping

In order to get the data types for our events properties do the
following:

[arabic]
. Log in to https://security.microsoft.com[Microsoft 365 Defender] and
go to https://security.microsoft.com/hunting-package[Advanced Hunting
page].
. Run the following query to get the data types mapping for each event:
+
[source,kusto]
----
{EventType}
| getschema
| project ColumnName, ColumnType
----

* Here is an example for Device Info event:
+
:::image type=``content'' source=``images/data-types-mapping-query.png''
alt-text=``The Event Hubs with resource ID3''
lightbox=``images/data-types-mapping-query.png'':::

=== Related topics

* link:/microsoft-365/security/defender/streaming-api[Stream Microsoft
365 Defender events | Microsoft Learn]
* link:advanced-hunting-overview.md[Overview of Advanced Hunting]
* link:raw-data-export.md[Microsoft Defender for Endpoint Streaming API]
* link:raw-data-export-storage.md[Stream Microsoft Defender for Endpoint
events to your Azure storage account]
* link:/azure/storage/common/storage-account-overview[Azure Storage
Account documentation]
