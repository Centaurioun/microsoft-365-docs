= Stream Microsoft Defender for Endpoint events to Azure Event Hubs
:audience: ITPro
:author: mjcaparas
:description: Learn how to configure Microsoft Defender for Endpoint to stream Advanced Hunting events to your Event Hub.
:experimental:
:keywords: raw data export, streaming API, API, Azure Event Hubs, Azure storage, storage account, Advanced Hunting, raw data sharing
:manager: dansimp
:ms.author: macapara
:ms.collection: M365-security-compliance
:ms.custom: api
:ms.localizationpriority: medium
:ms.mktglfcycl: deploy
:ms.pagetype: security
:ms.service: microsoft-365-security
:ms.sitesec: library
:ms.subservice: mde
:ms.topic: article
:search.appverid: met150

== Configure Microsoft Defender for Endpoint to stream Advanced Hunting events to your Azure Event Hubs

[!INCLUDE xref:../../includes/microsoft-defender.adoc[Microsoft 365 Defender rebranding]]

*Applies to:*

* https://go.microsoft.com/fwlink/p/?linkid=2154037[Microsoft Defender for Endpoint Plan 2]

____
Want to experience Defender for Endpoint?
https://signup.microsoft.com/create-account/signup?products=7f379fee-c4f9-4278-b0a1-e4c8c2fcdf7e&ru=https://aka.ms/MDEp2OpenTrial?ocid=docs-wdatp-configuresiem-abovefoldlink[Sign up for a free trial.]
____

=== Before you begin

. Create an link:/azure/event-hubs/[event hub] in your tenant.
. Log in to your https://ms.portal.azure.com/[Azure tenant], go to menu:Subscriptions[Your subscription > Resource Providers > Register to Microsoft.insights].

=== Enable raw data streaming

. Log in to the https://security.microsoft.com[Microsoft 365 Defender] as a *_Global Administrator_* or *_Security Administrator_*.
. Go to the https://security.microsoft.com/interoperability/dataexport[Data export settings page] in the Microsoft Defender portal.
. Click on *Add data export settings*.
. Choose a name for your new settings.
. Choose *Forward events to Azure Event Hubs*.
. Type your *Event Hubs name* and your *Event Hubs resource ID*.
+
In order to get your *Event Hubs resource ID*, go to your Azure Event Hubs namespace page on https://ms.portal.azure.com/[Azure] > properties tab > copy the text under *Resource ID*:
+
:::image type="content" source="images/event-hub-resource-id.png" alt-text="The Event Hubs resource Id-1" lightbox="images/event-hub-resource-id.png":::

. Choose the events you want to stream and click *Save*.

=== The schema of the events in Azure Event Hubs

[,json]
----
{
    "records": [
                    {
                        "time": "<The time WDATP received the event>"
                        "tenantId": "<The Id of the tenant that the event belongs to>"
                        "category": "<The Advanced Hunting table name with 'AdvancedHunting-' prefix>"
                        "properties": { <WDATP Advanced Hunting event as Json> }
                    }
                    ...
                ]
}
----

* Each event hub message in Azure Event Hubs contains list of records.
* Each record contains the event name, the time Microsoft Defender for Endpoint received the event, the tenant it belongs (you will only get events from your tenant), and the event in JSON format in a property called "*properties*".
* For more information about the schema of Microsoft Defender for Endpoint events, see xref:advanced-hunting-overview.adoc[Advanced Hunting overview].
* In Advanced Hunting, the *DeviceInfo* table has a column named *MachineGroup* which contains the group of the device.
Here every event will be decorated with this column as well.
See xref:machine-groups.adoc[Device Groups] for more information.
+
____
[!NOTE] Device group creation is supported in Defender for Endpoint Plan 1 and Plan 2.
____

=== Data types mapping

To get the data types for event properties do the following:

. Log in to https://security.microsoft.com[Microsoft 365 Defender] and go to https://security.microsoft.com/hunting-package[Advanced Hunting page].
. Run the following query to get the data types mapping for each event:
+
[,kusto]
----
{EventType}
| getschema
| project ColumnName, ColumnType
----

* Here is an example for Device Info event:
+
:::image type="content" source="images/machine-info-datatype-example.png" alt-text="The Event Hubs resource Id-2" lightbox="images/machine-info-datatype-example.png":::

=== Related topics

* xref:advanced-hunting-overview.adoc[Overview of Advanced Hunting]
* xref:raw-data-export.adoc[Microsoft Defender for Endpoint streaming API]
* xref:raw-data-export-storage.adoc[Stream Microsoft Defender for Endpoint events to your Azure storage account]
* link:/azure/event-hubs/[Azure Event Hubs documentation]
* link:/azure/event-hubs/troubleshooting-guide[Troubleshoot connectivity issues - Azure Event Hubs]
