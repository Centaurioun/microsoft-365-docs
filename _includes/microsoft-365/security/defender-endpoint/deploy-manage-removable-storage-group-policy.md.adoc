= Deploy and manage Removable Storage Access Control using group policy
:audience: ITPro
:author: dansimp
:description: Use group policy to deploy and manage removable storage access control.
:manager: dansimp
:ms.author: dansimp
:ms.collection: M365-security-compliance
:ms.custom: admindeeplinkDEFENDER
:ms.date: 09/09/2022
:ms.localizationpriority: medium
:ms.mktglfcycl: deploy
:ms.pagetype: security
:ms.reviewer: tewchen
:ms.service: microsoft-365-security
:ms.sitesec: library
:ms.subservice: mde
:ms.topic: conceptual
:search.appverid: met150

== Deploy and manage Removable Storage Access Control using group policy

*Applies to:*

* https://go.microsoft.com/fwlink/p/?linkid=2154037[Microsoft Defender for Endpoint Plan 2]

____
[!NOTE] The Group Policy management and Intune OMA-URI/Custom Policy management of this product are now generally available (4.18.2106): See https://techcommunity.microsoft.com/t5/microsoft-defender-for-endpoint/protect-your-removable-storage-and-printers-with-microsoft/ba-p/2324806[Tech Community blog: Protect your removable storage and printer with Microsoft Defender for Endpoint].
____

The Removable Storage Access Control feature enables you to apply a policy by using group policy to either user or device, or both.

=== Device Control Removable Storage Access Control policies

You can use the following properties to create a removable storage group.

____
[!NOTE] Comments using XML comment notation `+<!-- COMMENT -->+` can be used in the Rule and Group XML files, but they must be inside the first XML tag, not the first line of the XML file.
____

=== Licensing requirements

Before you get started with Removable Storage Access Control, you must confirm your https://www.microsoft.com/microsoft-365/compare-microsoft-365-enterprise-plans?rtc=2[Microsoft 365 subscription].
To access and use Removable Storage Access Control through group policy, you must have Microsoft 365 E5.

=== Deploy using group policy

. Enable or Disable Removable Storage Access Control:
+
You can enable or disable Device control as follows:

 ** Go to *Computer Configuration* > *Administrative Templates* > *Windows Components* > *Microsoft Defender Antivirus* > *Features* > *Device Control*.
 ** In the *Device Control* window, select *Enabled*.

+
:::image type="content" source="images/enable-rsac-gp.png" alt-text="Screenshot of Enabling RSAC using Group Policy " lightbox="images/enable-rsac-gp.png":::

____
[!NOTE] If you don't see this group policy objects, you need to add the group policy administrative template.
You can download administrative template (WindowsDefender.adml and WindowsDefender.admx) from https://github.com/microsoft/mdatp-devicecontrol/tree/main/Removable%20Storage%20Access%20Control%20Samples.
____

. Set Default Enforcement:
+
You can set default access (Deny or Allow) for all Device Control features (RemovableMediaDevices, CdRomDevices, WpdDevices, PrinterDevices).
+
For example, you can have either a Deny or an Allow policy for RemovableMediaDevices, but not for CdRomDevices or WpdDevices.
You set Default Deny through this policy, then Read/Write/Execute access to CdRomDevices or WpdDevices will be blocked.
If you only want to manage storage, make sure to create Allow policy for Printer.
Otherwise, this Default Enforcement will be applied to Printer as well.

 ** Go to *Computer Configuration* > *Administrative Templates* > *Windows Components* > *Microsoft Defender Antivirus* > *Features* > *Device Control* > *Select Device Control Default Enforcement*
 ** In the *Select Device Control Default Enforcement* pane, select *Default Deny*:

+
:::image type="content" source="images/set-default-enforcement-deny-gp.png" alt-text="Screenshot of setting Default Enforcement = Deny using Group Policy" lightbox="images/set-default-enforcement-deny-gp.png":::

. Create one XML file for removable storage group(s):
+
Use the properties in removable storage group to create an XML file for the Removable storage group(s), save the XML file to network share, and define the setting as follows:

 ** Go to *Computer Configuration* > *Administrative Templates* > *Windows Components* > *Microsoft Defender Antivirus* > *Device Control* > *Define device control policy groups*.

+
:::image type="content" source="images/define-device-control-policy-grps-gp.png" alt-text="Screenshot of Define device control policy groups" lightbox="images/define-device-control-policy-grps-gp.png":::

 ** In the *Define device control policy groups* window, specify the network share file path containing the XML groups data.

____
[!NOTE] Comments using XML comment notation `+<!-- COMMENT -->+` can be used in the Rule and Group XML files, but they must be inside the first XML tag, not the first line of the XML file.
____

. Create one XML file for access policy rule(s):
+
Use the properties in removable storage access policy rule(s) to create a XML for each group's removable storage access policy rule, save the XML file to network share, and devlier the setting setting as follows:

 ** Go to *Computer Configuration* > *Administrative Templates* > *Windows Components* > *Microsoft Defender Antivirus* > *Device Control* > *Define device control policy rules*.
+
:::image type="content" source="images/define-device-cntrl-policy-rules-gp.png" alt-text="Screenshot of define device control policy rules" lightbox="images/define-device-cntrl-policy-rules-gp.png":::

 ** In the *Define device control policy rules* window, select *Enabled*, and enter the network share file path containing the XML rules data.

____
[!NOTE] Comments using XML comment notation `+<!-- COMMENT -->+` can be used in the Rule and Group XML files, but they must be inside the first XML tag, not the first line of the XML file.
____

. Set location for a copy of the file (evidence):
+
If you want to have a copy of the file (evidence) when Write access happens, set right *Options* in your removable storage access policy rule in the XML file, and then specify the location where system can save the copy.

 ** Go to *Computer Configuration* > *Administrative Templates* > *Windows Components* > *Microsoft Defender Antivirus* > *Device Control* > *Define Device Control evidence data remote location*.
 ** In the *Define Device Control evidence data remote location* pane, select *Enabled*, and then specify the local or network share folder path.
+
:::image type="content" source="images/evidence-data-remote-location-gp.png" alt-text="Screenshot of Define Device Control evidence data remote location." lightbox="images/evidence-data-remote-location-gp.png":::

=== Scenarios

Here are some common scenarios to help you familiarize with Microsoft Defender for Endpoint Removable Storage Access Control.
Note that in the following samples, 'Default Enforcement' hasn't been used because the 'Default Enforcement' will apply to both the removable storage and the printer.

==== Scenario 1: Prevent Write and Execute access to all but allow specific approved USBs

For this scenario, you need to create two groups - one group for any removable storage and another group for approved USBs.
You also need to create two policies - one policy to deny Write and Execute access for any removable storage group and the other policy to audit the approved USBs group.

. Create groups
 .. Group 1: Any removable storage, CD/DVD, and Windows portable devices.

+
image::https://user-images.githubusercontent.com/81826151/188234308-4db09787-b14e-446a-b9e0-93c99b08748f.png[A screenshot of removable storage]
 .. Group 2: Approved USBs based on device properties.

+
image::https://user-images.githubusercontent.com/81826151/188234372-526d20b3-cfea-4f1d-8d63-b513497ada52.png[A screenshot of approved USBs]
+
Combine these two groups into https://github.com/microsoft/mdatp-devicecontrol/blob/main/Removable%20Storage%20Access%20Control%20Samples/Group%20Policy/Demo_Groups.xml[one XML file].
See step 3 from the link:deploy-manage-removable-storage-group-policy.md#deploy-using-group-policy[Deploy using group policy] section to deploy this configuration.
+
____
[!TIP] Replace `&` with `+&amp;+` in the value.
____
. Create policy
 .. Policy 1: Block Write and Execute access for any removable storage group but allow approved USBs.

+
image::https://user-images.githubusercontent.com/81826151/188237490-d736ace1-4912-4788-9e94-3fc506692a41.png[A screenshot of block write and execute access]
 .. Policy 2: Audit Write and Execute access for allowed USBs.

+
image::https://user-images.githubusercontent.com/81826151/188237598-b28dd534-9ea4-4cdd-832b-afff50f9897b.png[A screenshot of audit write and execute access]
+
What does '54' mean in the policy?
It's 18 + 36 = 54:
 ** Write access: disk level 2 + file system level 16 = 18.
 ** Execute: disk level 4 + file system level 32 = 36.

+
Combine these two policy rules into https://github.com/microsoft/mdatp-devicecontrol/blob/main/Removable%20Storage%20Access%20Control%20Samples/Group%20Policy/Scenario%201%20GPO%20Policy%20-%20Prevent%20Write%20and%20Execute%20access%20to%20all%20but%20allow%20specific%20approved%20USBs.xml[one XML file].
See step 4 from the link:deploy-manage-removable-storage-group-policy.md#deploy-using-group-policy[Deploy using group policy] section to deploy this configuration.

==== Scenario 2: Audit Write and Execute access for all but block specific blocked USBs

For this scenario, you need to create two groups - one group for any removable storage and another group for blocked USBs.
You also need to create two policies - one policy to audit Write and Execute access for any removable storage group and the other policy to deny the blocked USBs group.

. Create groups
 .. Group 1: Any removable storage, CD/DVD, and windows portable devices.

+
image::https://user-images.githubusercontent.com/81826151/188234308-4db09787-b14e-446a-b9e0-93c99b08748f.png[A screenshot of removable storage in groups]
 .. Group 2: Blocked USBs based on device properties.

+
image::https://user-images.githubusercontent.com/81826151/188234372-526d20b3-cfea-4f1d-8d63-b513497ada52.png[A screenshot of blocked USBs]
+
Combine these two groups into https://github.com/microsoft/mdatp-devicecontrol/blob/main/Removable%20Storage%20Access%20Control%20Samples/Group%20Policy/Demo_Groups.xml[one XML file].
See step 3 from the link:deploy-manage-removable-storage-group-policy.md#deploy-using-group-policy[Deploy using group policy] section to deploy this configuration.
+
____
[!TIP] Replace `&` with `+&amp;+` in the value.
____
. Create policy
 .. Policy 1: Block Write and Execute access for all but block specific unapproved USBs.

+
image::https://user-images.githubusercontent.com/81826151/188239025-218a1985-b198-4f7e-b323-b4b6fb7e274e.png[A screenshot of specific unapproved USBs]
 .. Policy 2: Audit Write and Execute access for others.

+
image::https://user-images.githubusercontent.com/81826151/188239144-3e6a2781-6927-487a-aa01-498a0904ad98.png[A screenshot of audit write and execute access in group policy]
+
What does '54' mean in the policy?
It's 18 + 36 = 54:
 ** Write access: disk level 2 + file system level 16 = 18.
 ** Execute: disk level 4 + file system level 32 = 36.

+
Combine these two policy rules into https://github.com/microsoft/mdatp-devicecontrol/blob/main/Removable%20Storage%20Access%20Control%20Samples/Group%20Policy/Scenario%202%20GPO%20Policy%20-%20Audit%20Write%20and%20Execute%20access%20to%20all%20but%20block%20specific%20unapproved%20USBs.xml[one XML file].
See step 4 from the link:deploy-manage-removable-storage-group-policy.md#deploy-using-group-policy[Deploy using group policy] section to deploy this configuration.
