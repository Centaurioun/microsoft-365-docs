= Onboard and offboard macOS devices into Microsoft Purview solutions using JAMF Pro
:audience: ITPro
:author: chrfox
:description: Learn how to onboard and offboard macOS devices into Microsoft Purview solutions using JAMF Pro
:f1.keywords: NOCSH
:manager: laurawi
:ms.author: chrfox
:ms.collection: ["M365-security-compliance"]
:ms.date:
:ms.localizationpriority: medium
:ms.service: O365-seccomp
:ms.topic: article
:search.appverid: ["MET150"]

== Onboard and offboard macOS devices into Microsoft Purview solutions using JAMF Pro

You can use JAMF Pro to onboard macOS devices into Microsoft Purview solutions like Endpoint data loss prevention.

____
[!IMPORTANT] Use this procedure if you *_do not_* have Microsoft Defender for Endpoint (MDE) deployed to your macOS devices
____

*Applies to:*

* xref:./endpoint-dlp-learn-about.adoc[Endpoint data loss prevention (DLP)]
* xref:insider-risk-management.adoc[Insider risk management]

=== Before you begin

* Make sure your https://www.jamf.com/resources/product-documentation/jamf-pro-installation-guide-for-mac/[macOS devices are managed through JAMF pro] and are associated with an identity (Azure AD joined UPN) through JAMF Connect or Intune.
* Install the v95+ Edge browser on your macOS devices

=== Onboard devices into Microsoft Purview solutions using JAMF Pro

. You'll need these files for this procedure.

|===
| File needed for | Source

| Onboarding package
| Downloaded from the compliance portal *Onboarding package*, file name _DeviceComplianceOnboarding.plist_

| accessibility
| https://github.com/microsoft/mdatp-xplat/blob/master/macos/mobileconfig/profiles/accessibility.mobileconfig[accessibility.mobileconfig]

| full disk access
| https://github.com/microsoft/mdatp-xplat/blob/master/macos/mobileconfig/profiles/fulldisk.mobileconfig[fulldisk.mobileconfig]

| Network filter
| https://github.com/microsoft/mdatp-xplat/blob/master/macos/mobileconfig/profiles/netfilter.mobileconfig[netfilter.mobileconfig]

| System extensions
| https://github.com/microsoft/mdatp-xplat/blob/master/macos/mobileconfig/profiles/sysext.mobileconfig[sysext.mobileconfig]

| MDE preference
| https://github.com/microsoft/mdatp-xplat/blob/master/macos/settings/data_loss_prevention/schema.json[schema.json]

| MAU preference
| https://github.com/microsoft/mdatp-xplat/blob/master/macos/settings/microsoft_auto_update/com.microsoft.autoupdate2.plist[com.microsoft.autoupdate2.plist]

| Installation package
| downloaded from the compliance portal *Installation package*, file name _*wdav.pkg_*
|===

____
[!TIP] You can download the _.mobileconfig_ files individually or in https://github.com/microsoft/mdatp-xplat/blob/master/macos/mobileconfig/combined/mdatp-nokext.mobileconfig[single combined file] that contains:

* accessibility.mobileconfig
* fulldisk.mobileconfig
* netfilter.mobileconfig
* sysext.mobileconfig

If any of these individual files is updated, you'd need to download either the combined file again or the single updated file individually.
____

Onboarding a macOS device into Compliance solutions is a multiphase process.

==== Get the device onboarding package

. In *Compliance center* open *Settings* > *Device Onboarding* and choose *Onboarding*.
. For *Select operating system to start onboarding process* choose *macOS*
. For *Deployment method* choose *Mobile Device Management/Microsoft Intune*
. Choose *Download onboarding package*
. Extract the contents of the device onboarding package.
In the JAMF folder, you should see the _DeviceComplainceOnboarding.plist_ file.

==== Create a JAMF Pro configuration profile for the onboarding package

. Create a new configuration profile in JAMF Pro.
Refer to the https://www.jamf.com/resources/product-documentation/jamf-pro-administrators-guide/[JAMF Pro administrators guide].
Use these values:
 ** Name: `MDATP onboarding for macOS`
 ** Description: `MDATP EDR onboarding for macOS`
 ** Category: `none`
 ** Distribution method: `install automatically`
 ** Level: `computer level`
. In the JAMF Pro console > *Application & Custom settings*, choose *upload* and then *add*.
Use this value:
 ** Preference Domain: `com.microsoft.wdav.atp`
. Choose *upload* and select the onboarding file *DeviceComplianceOnboarding.plist*.
. Choose the *scope* tab.
. Choose the target computers.
. Choose *Save*.
. Choose *Done*.

==== Configure Preference domain using the JAMF PRO console

____
[!IMPORTANT] You must use *_com.microsoft.wdav_* as the Preference Domain value.
Microsoft Defender for Endpoint uses this name and *_com.microsoft.wdav.ext_* to load its managed settings.
____

. Create a new configuration profile in JAMF Pro.
Refer to the https://www.jamf.com/resources/product-documentation/jamf-pro-administrators-guide/[JAMF Pro administrators guide].
Use these values:
 ** Name: `MDATP MDAV configuration settings`
 ** Description: leave this blank
 ** Category: `none`
 ** Distribution method: `install automatically`
 ** Level: `computer level`
. On the *Application & Custom Settings* tab, choose *External Applications*, choose *Add* and choose *Custom Schema* for the preference domain.
Use this value:
 ** Preference domain: `com.microsoft.wdav`
. Choose *Add Schema* and *Upload* to upload the _schema.json_ file.
. Choose *Save*.
. Under *Preference Domain Properties* choose these settings
 ** Features
  *** Use System Extensions: `enabled` - required for network extensions on Catalina
  *** Use Data Loss Prevention: `enabled`
 ** Antivirus engine > Passive mode: `true|false`.
Use ``true``if deploying DLP only.
Use `false` or do not assign a value if deploying DLP and Microsoft Defender for Endpoint (MDE).
. Choose the *Scope* tab.
. Choose the groups to deploy this configuration profile to.
. Choose *Save*.

==== Create and deploy a configuration profile for Microsoft AutoUpdate (MAU)

. Create a JAMF Pro configuration file using the *com.microsoft.autoupdate2.plist*.
Refer to the https://www.jamf.com/resources/product-documentation/jamf-pro-administrators-guide/[JAMF Pro administrators guide].
Use these values:
 ** Name: `MDATP MDAV MAU settings`
 ** Description: `Microsoft AutoUPdate settings for MDATP for macOS`
 ** Category: `none`
 ** Distribution method: `install automatically`
 ** Level: `computer level`
. In *Application & Custom Settings* choose *Upload* and *Add*.
. In *Preferences Domain* enter `com.microsoft.autoupdate2` and then choose *Upload*.
. Choose the *com.microsoft.autoupdate2.plist* file.
. Choose *Save*.
. Choose the *Scope* tab.
. Choose the target computers.
. Choose *Save*.
. Choose *Done*.

==== Create and deploy a configuration profile for Grant full disk access

. Use the *fulldisk.mobileconfig* file.
. Upload the *fulldisk.mobileconfig* file to JAMF.
Refer to https://docs.jamf.com/technical-articles/Deploying_Custom_Configuration_Profiles_Using_Jamf_Pro.html[Deploying Custom Configuration Profiles using JAMF Pro].

==== Create and deploy a configuration profile for System extensions

. Create a JAMF Pro configuration file using the procedures in https://www.jamf.com/resources/product-documentation/jamf-pro-administrators-guide/[JAMF Pro administrators guide].
Use these values:
 ** Name: `MDATP MDAV System Extensions`
 ** Description: `MDATP system extensions`
 ** Category: `none`
 ** Distribution method: `install automatically`
 ** Level: `computer level`
. In *System extensions* profile, enter these values:
 ** Display Name: `Microsoft Corp.
System Extensions`
 ** System Extension Types: `Allowed System Extensions`
 ** Team Identifier: `UBF8T346G9`
 ** Allowed System Extensions: `com.microsoft.wdav.epsext`, and `com.microsoft.wdav.netext`
. Choose the *Scope* tab.
. Choose the target computers.
. Choose *Save*.
. Choose *Done*.

==== Configure Network extension

. Use the *netfilter.mobileconfig*  file that you downloaded from GitHub.
. Upload to JAMF as described in https://www.jamf.com/jamf-nation/articles/648/deploying-custom-configuration-profiles-using-jamf-pro[Deploying Custom Configuration Profiles using Jamf Pro].

==== Grant accessibility access to DLP

. Use the *accessibility.mobileconfig* file that you downloaded from GitHub.
. Upload to JAMF as described in https://www.jamf.com/jamf-nation/articles/648/deploying-custom-configuration-profiles-using-jamf-pro[Deploying Custom Configuration Profiles using Jamf Pro].

==== Get the installation package

. In *Compliance center* open *Settings* > *Device Onboarding* and choose *Onboarding*.
. For *Select operating system to start onboarding process* choose *macOS*
. For *Deployment method* choose *Mobile Device Management/Microsoft Intune*
. Choose *Download installation package*.
This will give you the _wdav.pkg_ file.

==== Deploy the installation package

. Navigate to where you saved the `wdav.pkg` file.
. Open the JAMF Pro dashboard.
. Select your computer and click the gear at the top, then choose *Computer Management*.
. In *Packages* choose *+New*.
Enter these details:
 ** Display Name: leave blank because it will be reset when you choose the .pkg file.
 ** Category: None (default)
 ** Filename: Choose file, in this case the `wdav.pkg` file.
. Choose *Open*.
Set:
 ** *Display Name*: `Microsoft Endpoint Technology`
 ** *Manifest File*: not required
 ** *Options tab*: leave default values
 ** *Limitations tab*: leave default values
. Choose *Save*.
This uploads the package to JAMF Pro.
. Open the *Policies* page.
. Choose *+New* to create a new policy.
. Enter these values
 ** *Display name*: `MDATP Onboarding200329 v100.86.92 or later`
. Choose *Recurring Check-in*.
. Choose *Save*.
. Choose *Packages* > *Configure*.
. Choose *Add*.
. Choose *Save*.
. Choose the *Scope* tab.
. Select the target computers.
. Choose *Add*.
. Choose *Self service*.
. Choose *Done*.

==== Check the macOS device

. Restart the macOS device.
. Open *System Preferences* > *Profiles*.
. You should see:
 ** Accessiblity
 ** Full Disk Access
 ** MAU
 ** MDATP Onboarding
 ** MDE Preferences
 ** Management profile
 ** Network filter
 ** System extension profile

=== Offboard macOS devices using JAMF Pro

. Uninstall the application (if not using MDE)
 .. See JAMF Pro Docs - Package Deployment - https://www.jamf.com/resources/product-documentation/jamf-pro-administrators-guide/[JAMF Pro administrators guide]Jamf Pro Administrator's Guide
. Restart the macOS device - some applications may lose printing functionality until they are restarted

____
[!IMPORTANT] Offboarding causes the device to stop sending sensor data to the portal but data from the device, including reference to any alerts it has had will be retained for up to 6 months.
____
