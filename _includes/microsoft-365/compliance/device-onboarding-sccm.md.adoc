= Onboard Windows 10 and Windows 11 devices using Configuration Manager
:audience: ITPro
:author: chrfox
:description: Use Configuration Manager to deploy the configuration package on devices so that they are onboarded to the service.
:f1.keywords: NOCSH
:manager: laurawi
:ms.author: chrfox
:ms.collection: ["M365-security-compliance"]
:ms.custom: admindeeplinkCOMPLIANCE
:ms.date:
:ms.localizationpriority: medium
:ms.service: O365-seccomp
:ms.topic: article
:search.appverid: ["MET150"]

== Onboard Windows 10 and Windows 11 devices using Configuration Manager

*Applies to:*

* xref:./endpoint-dlp-learn-about.adoc[Endpoint data loss prevention (DLP)]
* xref:insider-risk-management.adoc[Insider risk management]

[discrete]
==== Onboard devices using System Center Configuration Manager

. Get the configuration package .zip file (_DeviceComplianceOnboardingPackage.zip_) from https://compliance.microsoft.com/[Microsoft Purview compliance portal].
. In the navigation pane, select https://go.microsoft.com/fwlink/p/?linkid=2174201[*Settings*] > *Device Onboarding* > *Onboarding*.
. In the *Deployment method* field, select *Microsoft Endpoint Configuration Manager 2012/2012 R2/1511/1602*.
. Select *Download package*, and save the .zip file.
. Extract the contents of the .zip file to a shared, read-only location that can be accessed by the network administrators who will deploy the package.
You should have a file named _DeviceComplianceOnboardingScript.cmd_.
. Deploy the package by following the steps in the link:/previous-versions/system-center/system-center-2012-R2/gg699369(v=technet.10)[Packages and Programs in System Center 2012 R2 Configuration Manager] article.
. Choose a predefined device collection to deploy the package to.

____
[!NOTE] Microsoft 365 information protection doesn't support onboarding during the https://answers.microsoft.com/en-us/windows/wiki/windows_10/how-to-complete-the-windows-10-out-of-box/47e3f943-f000-45e3-8c5c-9d85a1a0cf87[Out-Of-Box Experience (OOBE)] phase.
Make sure users complete OOBE after running Windows installation or upgrading.
____

____
[!TIP] After onboarding the device, you can choose to run a detection test to verify that a device is properly onboarded to the service.
For more information, see link:/windows/security/threat-protection/microsoft-defender-atp/run-detection-test[Run a detection test on a newly onboarded Microsoft Defender for Endpoint device].

Note that it is possible to create a detection rule on a Configuration Manager application to continuously check if a device has been onboarded.
An application is a different type of object than a package and program.
If a device is not yet onboarded (due to pending OOBE completion or any other reason), Configuration Manager will retry to onboard the device until the rule detects the status change.

This behavior can be accomplished by creating a detection rule checking if the "OnboardingState" registry value (of type REG_DWORD) = 1.
This registry value is located under "HKLM\SOFTWARE\Microsoft\Windows Advanced Threat Protection\Status".
For more information, see link:/previous-versions/system-center/system-center-2012-R2/gg682159(v=technet.10)#step-4-configure-detection-methods-to-indicate-the-presence-of-the-deployment-type[Configure Detection Methods in System Center 2012 R2 Configuration Manager].
____

[discrete]
==== Configure sample collection settings

For each device, you can set a configuration value to state whether samples can be collected from the device when a request is made through Microsoft Defender Security Center to submit a file for deep analysis.

____
[!NOTE] These configuration settings are typically done through Configuration Manager.
____

You can set a compliance rule for configuration item in Configuration Manager to change the sample share setting on a device.

This rule should be a _remediating_ compliance rule configuration item that sets the value of a registry key on targeted devices to make sure they're complaint.

The configuration is set through the following registry key entry:

[,text]
----
Path: "HKLM\SOFTWARE\Policies\Microsoft\Windows Advanced Threat Protection"
Name: "AllowSampleCollection"
Value: 0 or 1
----

Where:

Key type is a D-WORD.

Possible values are:

* 0 - doesn't allow sample sharing  from this device
* 1 - allows sharing of all file types from this device

The default value in case the registry key doesn't exist is 1.

For more information about System Center Configuration Manager Compliance, see link:/previous-versions/system-center/system-center-2012-R2/gg682139(v=technet.10)[Introduction to compliance settings in System Center 2012 R2 Configuration Manager].

=== Other recommended configuration settings

After onboarding devices to the service, it's important to take advantage of the included threat protection capabilities by enabling them with the following recommended configuration settings.

==== Device collection configuration

If you're using Endpoint Configuration Manager, version 2002 or later, you can choose to broaden the deployment to include servers or down-level clients.

==== Next generation protection configuration

The following configuration settings are recommended:

*Scan*

* Scan removable storage devices such as USB drives: Yes

*Real-time Protection*

* Enable Behavioral Monitoring: Yes
* Enable protection against Potentially Unwanted Applications at download and prior to installation: Yes

*Cloud Protection Service*

* Cloud Protection Service membership type: Advanced membership

*Attack surface reduction* Configure all available rules to Audit.

____
[!NOTE] Blocking these activities may interrupt legitimate business processes.
The best approach is setting everything to audit, identifying which ones are safe to turn on, and then enabling those settings on endpoints which do not have false positive detections.
____

*Network protection*

Prior to enabling network protection in audit or block mode, ensure that you've installed the antimalware platform update, which can be obtained from the https://support.microsoft.com/en-us/help/4560203/windows-defender-anti-malware-platform-binaries-are-missing[support page].

*Controlled folder access*

Enable the feature in audit mode for at least 30 days.
After this period, review detections and create a list of applications that are allowed to write to protected directories.

For more information, see link:/windows/security/threat-protection/microsoft-defender-atp/evaluate-controlled-folder-access[Evaluate controlled folder access].

=== Offboard devices using Configuration Manager

For security reasons, the package used to Offboard devices will expire 30 days after the date it was downloaded.
Expired offboarding packages sent to a device will be rejected.
When downloading an offboarding package, you will be notified of the packages expiry date and it will also be included in the package name.

____
[!NOTE] Onboarding and offboarding policies must not be deployed on the same device at the same time, otherwise this will cause unpredictable collisions.
____

==== Offboard devices using Microsoft Endpoint Configuration Manager current branch

If you use Microsoft Endpoint Configuration Manager current branch, see link:/configmgr/protect/deploy-use/windows-defender-advanced-threat-protection#create-an-offboarding-configuration-file[Create an offboarding configuration file].

==== Offboard devices using System Center 2012 R2 Configuration Manager

. Get the offboarding package from https://go.microsoft.com/fwlink/p/?linkid=2077149[Microsoft Purview compliance portal]:
. In the navigation pane, select https://go.microsoft.com/fwlink/p/?linkid=2174201[*Settings*] >  *Device onboarding*> *Offboarding*.
. Select Windows 10 as the operating system.
. In the *Deployment method* field, select *Microsoft Endpoint Configuration Manager 2012/2012 R2/1511/1602*.
. Select *Download package*, and save the .zip file.
. Extract the contents of the .zip file to a shared, read-only location that can be accessed by the network administrators who will deploy the package.
You should have a file named _DeviceComplianceOffboardingScript_valid_until_YYYY-MM-DD.cmd_.
. Deploy the package by following the steps in the link:/previous-versions/system-center/system-center-2012-R2/gg699369(v=technet.10)[Packages and Programs in System Center 2012 R2 Configuration Manager] article.
. Choose a predefined device collection to deploy the package to.

____
[!IMPORTANT] Offboarding causes the device to stop sending sensor data to the portal but data from the device, including reference to any alerts it has had will be retained for up to 6 months.
____

=== Monitor device configuration

If you're using Microsoft Endpoint Configuration Manager current branch, use the built-in Microsoft Defender for Endpoint dashboard in the Configuration Manager console.
For more information, see link:/configmgr/protect/deploy-use/windows-defender-advanced-threat-protection#monitor[Microsoft Defender Advanced Threat Protection - Monitor].

If you're using System Center 2012 R2 Configuration Manager, monitoring consists of two parts:

. Confirming the configuration package has been correctly deployed and is running (or has successfully run) on the devices in your network.
. Checking that the devices are compliant with the Microsoft 365 device onboarding service (this ensures the device can complete the onboarding process and can continue to report data to the service).

==== Confirm the configuration package has been correctly deployed

. In the Configuration Manager console, click *Monitoring* at the bottom of the navigation pane.
. Select *Overview* and then *Deployments*.
. Select on the deployment with the package name.
. Review the status indicators under *Completion Statistics* and *Content Status*.
+
If there are failed deployments (devices with *Error*, *Requirements Not Met*, or *Failed statuses*), you may need to  troubleshoot the devices.
For more information, see, link:/windows/security/threat-protection/microsoft-defender-atp/troubleshoot-onboarding[Troubleshoot Microsoft Defender Advanced Threat Protection onboarding issues].
+
image::../media/sccm-deployment.png[Configuration Manager showing successful deployment with no errors.]

==== Check that the devices are compliant with the Endpoint data loss prevention service

You can set a compliance rule for configuration item in System Center 2012 R2 Configuration Manager to monitor your deployment.

____
[!NOTE] This procedure and registry entry applies to Endpoint DLP as well as Defender for Endpoint.
____

This rule should be a _non-remediating_ compliance rule configuration item that monitors the value of a registry key on targeted devices.

Monitor the following registry key entry:

[,text]
----
Path: "HKLM\SOFTWARE\Microsoft\Windows Advanced Threat Protection\Status"
Name: "OnboardingState"
Value: "1"
----

For more information, see link:/previous-versions/system-center/system-center-2012-R2/gg682139(v=technet.10)[Introduction to compliance settings in System Center 2012 R2 Configuration Manager].

=== Related topics

* xref:device-onboarding-gp.adoc[Onboard Windows 10 and Windows 11 devices using Group Policy]
* xref:device-onboarding-mdm.adoc[Onboard Windows 10 and Windows 11 devices using Mobile Device Management tools]
* xref:device-onboarding-script.adoc[Onboard Windows 10 and Windows 11 devices using a local script]
* xref:device-onboarding-vdi.adoc[Onboard non-persistent virtual desktop infrastructure (VDI) devices]
* link:/windows/security/threat-protection/microsoft-defender-atp/run-detection-test[Run a detection test on a newly onboarded Microsoft Defender for Endpoint device]
* link:/windows/security/threat-protection/microsoft-defender-atp/troubleshoot-onboarding[Troubleshoot Microsoft Defender Advanced Threat Protection onboarding issues]
